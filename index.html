<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 ì—°ìˆ˜ë¹„ ì§€ì› ì‹ ì²­ì„œ</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind configuration for custom font (Inter)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50 font-['Inter']">
    <div id="app" class="p-4 sm:p-8">
        <!-- Application content will be rendered here by JavaScript -->
    </div>
    
    <script type="module">
        // --- Firebase Imports (ES Modules) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Constants and Globals ---
        const POSITIONS = ['êµì¥', 'êµê°', 'êµì‚¬'];
        const SUPPORT_AREAS = ['ì§ë¬´ì—°ìˆ˜', 'ìê²©ì·¨ë“', 'í•™ì›ìˆ˜ê°•', 'ë„ì„œêµ¬ì…', 'ëŒ€í•™(ì›) í•™ë¹„'];

        // Global variables provided by the environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const submissionCollectionPath = `artifacts/${appId}/public/data/training_support_records`;

        let db = null;
        let auth = null;
        let appUserId = null;
        let adminId = null; // User ID who signs in with the initialAuthToken
        let isAuthReady = false;
        
        // Application State Management (replaces React state hooks)
        let appState = {
            submissions: [],
            isDataLoading: true,
            showAdminView: false,
            message: '',
            isSubmitting: false,
            editingId: null,
            editForm: { courseName: '', amount: '' },
            isConfirmingDelete: false,
            itemToDelete: null,
        };
        
        // --- Helper: Exponential Backoff Retry Logic ---
        const withRetry = async (fn, retries = 3, delay = 1000) => {
            try {
                return await fn();
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Attempt failed, retrying in ${delay}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return withRetry(fn, retries - 1, delay * 2);
                }
                throw error;
            }
        };

        // --- Authentication and Initialization ---
        const isAdmin = () => appUserId && adminId && appUserId === adminId;

        const initFirebase = () => {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Auth logic
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    appUserId = user.uid;
                } else {
                    appUserId = crypto.randomUUID();
                }
                isAuthReady = true;

                if (initialAuthToken) {
                    try {
                        // Custom Token Sign In (Identifies the Admin/Owner)
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        adminId = userCredential.user.uid;
                    } catch (error) {
                        console.error("Custom token sign in failed:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        if (!auth.currentUser) await signInAnonymously(auth);
                    }
                } else {
                    // Anonymous Sign In for other users
                    if (!auth.currentUser) await signInAnonymously(auth);
                }

                renderApp(); // Initial render after auth is ready
                setupRealtimeListener();
            });
        };
        
        // --- CRUD Handlers (Admin) ---
        
        // Deletion Handlers (exposed globally via window)
        window.startDelete = (id) => {
            if (!isAdmin()) return;
            const item = appState.submissions.find(s => s.id === id);
            if (!item) return;
            appState.itemToDelete = item;
            appState.isConfirmingDelete = true;
            renderApp();
        };

        window.cancelDelete = () => {
            appState.isConfirmingDelete = false;
            appState.itemToDelete = null;
            renderApp();
        };

        window.confirmDelete = async () => {
            if (!isAdmin() || !db || !appState.itemToDelete) return;
            
            const id = appState.itemToDelete.id;
            appState.isConfirmingDelete = false;
            appState.itemToDelete = null;

            try {
                await withRetry(() => deleteDoc(doc(db, submissionCollectionPath, id)));
                appState.message = `âœ… í•­ëª© (${id.substring(0, 4)}...) ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
            } catch (error) {
                console.error("Deletion failed:", error);
                appState.message = 'âŒ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
            }
            renderApp();
        };

        // Edit Handlers (exposed globally via window)
        window.startEdit = (id) => {
            if (!isAdmin()) return;
            const item = appState.submissions.find(s => s.id === id);
            if (!item) return;
            appState.editingId = id;
            appState.editForm = { courseName: item.courseName, amount: item.amount.toString() };
            renderApp();
        };

        window.cancelEdit = () => {
            appState.editingId = null;
            appState.editForm = { courseName: '', amount: '' };
            renderApp();
        };

        window.handleUpdate = async (id) => {
            if (!isAdmin() || !db) return;
            
            // Read values directly from DOM elements
            const courseInput = document.getElementById(`edit-course-${id}`);
            const amountInput = document.getElementById(`edit-amount-${id}`);

            const newCourseName = courseInput ? courseInput.value.trim() : appState.editForm.courseName;
            const newAmount = parseInt(amountInput ? amountInput.value : appState.editForm.amount);
            
            if (!newCourseName || isNaN(newAmount) || newAmount <= 0) {
                appState.message = 'ìˆ˜ì • ë‚´ìš©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                renderApp();
                return;
            }

            try {
                await withRetry(() => 
                    updateDoc(doc(db, submissionCollectionPath, id), {
                        courseName: newCourseName,
                        amount: newAmount
                    })
                );
                appState.message = `âœ… í•­ëª© (${id.substring(0, 4)}...) ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                appState.editingId = null;
                appState.editForm = { courseName: '', amount: '' };
            } catch (error) {
                console.error("Update failed:", error);
                appState.message = 'âŒ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
            }
            renderApp();
        };

        // --- Form Submission Handler ---
        window.handleSubmit = async (e) => {
            e.preventDefault();
            appState.message = '';
            appState.isSubmitting = true;
            renderApp();
            
            const form = e.target;
            const position = form.position.value;
            const name = form.name.value.trim();
            const supportArea = form.supportArea.value;
            const courseName = form.courseName.value.trim();
            const amount = parseInt(form.amount.value);

            if (!name || !courseName || isNaN(amount) || amount <= 0) {
                appState.message = 'ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.';
                appState.isSubmitting = false;
                renderApp();
                return;
            }

            if (!db || !appUserId) {
                appState.message = 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë˜ëŠ” ì¸ì¦ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
                appState.isSubmitting = false;
                renderApp();
                return;
            }

            try {
                const newSubmission = {
                    position,
                    name,
                    supportArea,
                    courseName,
                    amount,
                    userId: appUserId,
                    timestamp: serverTimestamp()
                };

                await withRetry(() => addDoc(collection(db, submissionCollectionPath), newSubmission));

                appState.message = 'âœ… ì‹ ì²­ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤! (ê´€ë¦¬ìë§Œ í˜„í™© í™•ì¸ ê°€ëŠ¥)';
                
                // Reset form inputs
                form.name.value = '';
                form.courseName.value = '';
                form.amount.value = '';
                // Dropdowns might retain selection, no need to force reset unless necessary
                
            } catch (error) {
                console.error("Submission failed:", error);
                appState.message = 'âŒ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message;
            } finally {
                appState.isSubmitting = false;
                renderApp();
            }
        };

        // --- Real-time Data Listener ---
        const setupRealtimeListener = () => {
            if (db && appUserId && isAdmin()) { 
                const q = query(collection(db, submissionCollectionPath));
                
                onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Sort logic: Position -> Name -> Timestamp
                    data.sort((a, b) => {
                        if (a.position !== b.position) return a.position.localeCompare(b.position, 'ko');
                        if (a.name !== b.name) return a.name.localeCompare(b.name, 'ko');
                        return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0); 
                    });

                    appState.submissions = data;
                    appState.isDataLoading = false;
                    renderApp();
                }, (error) => {
                    console.error("Error fetching data:", error);
                    appState.submissions = []; 
                    
                    if (error.code === 'permission-denied') {
                        appState.message = "ë°ì´í„° ì¡°íšŒ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (Firestore ê·œì¹™ ì˜¤ë¥˜)";
                    } else {
                        appState.message = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    }

                    appState.isDataLoading = false;
                    renderApp();
                });
            } else if (appUserId && !isAdmin()) {
                 appState.isDataLoading = false;
                 renderApp();
            }
        };

        // --- Rendering Functions ---

        window.toggleAdminView = () => {
            appState.showAdminView = !appState.showAdminView;
            renderApp();
        };
        
        // Handle input changes for the edit modal, saving the value to appState
        window.handleEditFormChange = (field, value) => {
            appState.editForm = { ...appState.editForm, [field]: value };
        };


        const renderTableRows = () => {
            let lastPosition = null;
            let lastName = null;
            
            if (appState.submissions.length === 0) {
                const colSpan = isAdmin() ? "7" : "6";
                const message = appState.isDataLoading ? 'ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...' : (appState.message.includes('ê¶Œí•œ ì˜¤ë¥˜') ? appState.message : 'ì•„ì§ ì œì¶œëœ ì‹ ì²­ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return `
                    <tr>
                        <td colspan="${colSpan}" class="px-3 py-10 text-center text-sm text-gray-500">
                            ${message}
                        </td>
                    </tr>
                `;
            }

            return appState.submissions.map((item, index) => {
                const isGroupStart = item.position !== lastPosition || item.name !== lastName;
                const isEditing = appState.editingId === item.id;
                
                lastPosition = item.position;
                lastName = item.name;
                
                const timestampText = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'N/A';
                const rowClass = `transition duration-100 ${isEditing ? 'bg-indigo-50' : (index % 2 === 0 ? 'bg-white' : 'bg-gray-50')}`;
                
                // 4. ê³¼ì •ëª… (Editable)
                const courseContent = isEditing ? `
                    <input
                        type="text"
                        id="edit-course-${item.id}"
                        value="${appState.editForm.courseName}"
                        onchange="handleEditFormChange('courseName', this.value)"
                        class="w-full border-gray-300 rounded-md shadow-sm text-sm p-1 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                ` : item.courseName;

                // 5. ê¸ˆì•¡ (Editable)
                const amountContent = isEditing ? `
                    <input
                        type="number"
                        id="edit-amount-${item.id}"
                        value="${appState.editForm.amount}"
                        onchange="handleEditFormChange('amount', this.value)"
                        class="w-full border-gray-300 rounded-md shadow-sm text-sm p-1 text-right focus:ring-indigo-500 focus:border-indigo-500"
                    />
                ` : item.amount.toLocaleString('ko-KR');

                // 7. ê´€ë¦¬ (Admin Only) - Using SVG icons
                const adminControls = isAdmin() ? `
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-center">
                        ${isEditing ? `
                            <div class="flex justify-center space-x-1">
                                <button onclick="handleUpdate('${item.id}')" class="text-green-600 hover:text-green-800 p-1 rounded-full bg-green-100 transition duration-150" title="ì €ì¥">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                </button>
                                <button onclick="cancelEdit()" class="text-red-600 hover:text-red-800 p-1 rounded-full bg-red-100 transition duration-150" title="ì·¨ì†Œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"></path><path d="M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        ` : `
                            <div class="flex justify-center space-x-2">
                                <button onclick="startEdit('${item.id}')" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full transition duration-150" title="ìˆ˜ì •">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button onclick="startDelete('${item.id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full transition duration-150" title="ì‚­ì œ">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        `}
                    </td>
                ` : '';

                return `
                    <tr key="${item.id}" class="${rowClass}">
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold ${isGroupStart ? '' : 'text-gray-400'}">
                            ${isGroupStart ? item.position : 'â†³'}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium ${isGroupStart ? 'text-gray-900' : 'text-gray-400 italic'}">
                            ${isGroupStart ? item.name : 'â†³'}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${item.supportArea}
                        </td>
                        <td class="px-3 py-4 text-sm text-gray-700">
                            ${courseContent}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-right text-indigo-600">
                            ${amountContent}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-500">
                            ${timestampText}
                        </td>
                        ${adminControls}
                    </tr>
                `;
            }).join('');
        };


        const renderTable = () => {
            if (!isAdmin() || !appState.showAdminView) return '';

            return `
                <div class="mt-12">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-green-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="21" x2="10" y2="21"></line></svg>
                        ì‹¤ì‹œê°„ ì œì¶œ í˜„í™© (ê´€ë¦¬ì ë·°)
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">
                        ì‹ ì²­ì´ ì œì¶œë˜ëŠ” ì¦‰ì‹œ ì´ ëª©ë¡ì— ì‹¤ì‹œê°„ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤. **(ì§ìœ„ ë° ì„±ëª…ìœ¼ë¡œ ê·¸ë£¹í™”ë¨)**
                    </p>
                    <div class="overflow-x-auto mt-8 border border-gray-200 rounded-xl shadow-lg bg-white">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">ì§ìœ„</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">ì„±ëª…</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">ì§€ì› ë¶„ì•¼</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">ê³¼ì •ëª…</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">ê¸ˆì•¡ (ì›)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">ì œì¶œ ì‹œê°</th>
                                    ${isAdmin() ? '<th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">ê´€ë¦¬</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${renderTableRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };


        const renderApp = () => {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;

            // Get current form values to persist them during re-render
            const getCurrentValue = (id, defaultValue) => document.getElementById(id)?.value || defaultValue;
            const currentPosition = getCurrentValue('position', POSITIONS[0]);
            const currentSupportArea = getCurrentValue('supportArea', SUPPORT_AREAS[0]);
            const currentName = getCurrentValue('name', '');
            const currentCourseName = getCurrentValue('courseName', '');
            const currentAmount = getCurrentValue('amount', '');


            const adminToggle = isAdmin() ? `
                <div class="mt-8 text-center">
                    <button
                        onclick="toggleAdminView()"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white transition duration-150 ease-in-out ${appState.showAdminView ? 'bg-red-500 hover:bg-red-600 focus:ring-red-500' : 'bg-gray-700 hover:bg-gray-800 focus:ring-gray-700'}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2">
                            ${appState.showAdminView ? 
                                '<path d="M17.94 17.94A10.51 10.51 0 0 1 12 21c-7 0-10-7-10-7s.24-1.23.63-2.12M17.46 12.35l.59-.22M4.69 16.69l.4-.53M9.88 9.88c.85-.34 1.78-.5 2.72-.5a5.5 5.5 0 0 1 3.51 1.25"></path><line x1="2" y1="2" x2="22" y2="22"></line>' : 
                                '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle>'
                            }
                        </svg>
                        ${appState.showAdminView ? 'ì œì¶œ í˜„í™© ìˆ¨ê¸°ê¸° (ë¹„ê³µê°œ)' : 'ê´€ë¦¬ììš© ì œì¶œ í˜„í™© ë³´ê¸° (ë‚˜ë§Œ ë³´ê¸°)'}
                    </button>
                </div>
            ` : '';
            
            // Message rendering
            const messageHtml = appState.message ? `
                <div class="p-3 rounded-lg text-sm font-medium ${appState.message.startsWith('âœ…') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${appState.message}
                </div>
            ` : '';

            const submissionButtonContent = appState.isSubmitting ? `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                ì œì¶œ ì¤‘...
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                ì‹ ì²­í•˜ê¸°
            `;

            // Confirmation Modal rendering
            const modalHtml = appState.isConfirmingDelete && appState.itemToDelete ? `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                        <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            ì‚­ì œ í™•ì¸
                        </h3>
                        <p class="text-gray-700 mb-6">
                            ì •ë§ë¡œ ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                        </p>
                        <div class="bg-red-50 p-3 rounded-lg text-sm mb-6 border border-red-200">
                            <p><strong>ì§ìœ„/ì„±ëª…:</strong> ${appState.itemToDelete.position} / ${appState.itemToDelete.name}</p>
                            <p><strong>ê³¼ì •ëª…:</strong> ${appState.itemToDelete.courseName}</p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button
                                onclick="cancelDelete()"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150"
                            >
                                ì·¨ì†Œ
                            </button>
                            <button
                                onclick="confirmDelete()"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md"
                            >
                                ì‚­ì œ ì‹¤í–‰
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';
            
            // Main HTML structure (using template literals for dynamic content)
            appContainer.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <header class="text-center mb-8">
                        <h1 class="text-4xl font-extrabold text-indigo-700">2025. ëª©í¬ì´ë¡œì´ˆë“±í•™êµ ì—°ìˆ˜ë¹„ ì§€ì› ì‹ ì²­ì„œ</h1>
                    </header>

                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-indigo-100">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-indigo-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="21" x2="10" y2="21"></line></svg>
                            ì‹ ì²­ ì •ë³´ ì…ë ¥
                        </h2>
                        
                        ${!isAuthReady ? `
                             <div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                                ì¸ì¦ ì •ë³´ë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤...
                            </div>
                        ` : `
                            <p class="text-xs text-gray-500 mb-4 p-2 bg-gray-50 rounded-lg">
                               ğŸ”’ í˜„ì¬ ì‚¬ìš©ì ID: **${appUserId}** ${isAdmin() ? '<span class="text-indigo-600 font-bold">(ê´€ë¦¬ì)</span>' : ''}
                            </p>
                        `}

                        <form id="submission-form" onsubmit="handleSubmit(event)" class="space-y-6">
                            <!-- 1. ì§ìœ„ ë° ì„±ëª… -->
                            <div class="flex flex-col sm:flex-row gap-6">
                                <div class="flex-1">
                                    <label for="position" class="block text-sm font-medium text-gray-700 mb-1">ì§ìœ„</label>
                                    <select
                                        id="position"
                                        name="position"
                                        class="w-full pl-3 pr-10 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out appearance-none"
                                    >
                                        ${POSITIONS.map(p => `<option value="${p}" ${p === currentPosition ? 'selected' : ''}>${p}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">ì„±ëª… <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        <input
                                            type="text"
                                            id="name"
                                            name="name"
                                            value="${currentName}"
                                            placeholder="í™ê¸¸ë™"
                                            required
                                            class="w-full pl-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- 2. ì§€ì› ë¶„ì•¼ -->
                            <div>
                                <label for="supportArea" class="block text-sm font-medium text-gray-700 mb-1">ì§€ì› ë¶„ì•¼</label>
                                <select
                                    id="supportArea"
                                    name="supportArea"
                                    class="w-full pl-3 pr-10 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out appearance-none"
                                >
                                    ${SUPPORT_AREAS.map(a => `<option value="${a}" ${a === currentSupportArea ? 'selected' : ''}>${a}</option>`).join('')}
                                </select>
                            </div>

                            <!-- 3. ê³¼ì •ëª… -->
                            <div>
                                <label for="courseName" class="block text-sm font-medium text-gray-700 mb-1">ê³¼ì •ëª… <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                    <input
                                        type="text"
                                        id="courseName"
                                        name="courseName"
                                        value="${currentCourseName}"
                                        placeholder="ì˜ˆ: 2022 ê°œì •êµìœ¡ê³¼ì • ì—°ìˆ˜"
                                        required
                                        class="w-full pl-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                                    />
                                </div>
                            </div>

                            <!-- 4. ê¸ˆì•¡ -->
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">ê¸ˆì•¡ (ìˆ«ìë§Œ ì…ë ¥) <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                    <input
                                        type="number"
                                        id="amount"
                                        name="amount"
                                        value="${currentAmount}"
                                        placeholder="ì˜ˆ: 150000 (ì›)"
                                        required
                                        min="1"
                                        class="w-full pl-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                    />
                                </div>
                            </div>

                            <!-- Submission Message -->
                            <div id="message-container">
                                ${messageHtml}
                            </div>

                            <!-- Submit Button -->
                            <button
                                type="submit"
                                disabled="${appState.isSubmitting || !isAuthReady}"
                                class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-semibold rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:bg-indigo-400 disabled:cursor-not-allowed"
                            >
                                ${submissionButtonContent}
                            </button>
                        </form>
                    </div>
                    
                    ${adminToggle}
                    ${renderTable()}
                </div>
                ${modalHtml}
            `;
        };

        // Start the application after the window loads
        window.onload = initFirebase;
    </script>
</body>
</html>
