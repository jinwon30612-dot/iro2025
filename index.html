<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 연수비 지원 신청서</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind configuration for custom font (Inter)
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="min-h-screen bg-gray-50 font-['Inter']">
    <div id="app" class="p-4 sm:p-8">
        <!-- Application content will be rendered here by JavaScript -->
    </div>
    
    <script type="module">
        // --- Firebase Imports (ES Modules) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Constants and Globals ---
        const POSITIONS = ['교장', '교감', '교사'];
        const SUPPORT_AREAS = ['직무연수', '자격취득', '학원수강', '도서구입', '대학(원) 학비'];

        // Global variables provided by the environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const submissionCollectionPath = `artifacts/${appId}/public/data/training_support_records`;

        let db = null;
        let auth = null;
        let appUserId = null;
        let adminId = null; // User ID who signs in with the initialAuthToken
        let isAuthReady = false;
        
        // Application State Management (replaces React state hooks)
        let appState = {
            submissions: [],
            isDataLoading: true,
            showAdminView: false,
            message: '',
            isSubmitting: false,
            editingId: null,
            editForm: { courseName: '', amount: '' },
            isConfirmingDelete: false,
            itemToDelete: null,
        };
        
        // --- Helper: Exponential Backoff Retry Logic ---
        const withRetry = async (fn, retries = 3, delay = 1000) => {
            try {
                return await fn();
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Attempt failed, retrying in ${delay}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return withRetry(fn, retries - 1, delay * 2);
                }
                throw error;
            }
        };

        // --- Authentication and Initialization ---
        const isAdmin = () => appUserId && adminId && appUserId === adminId;

        const initFirebase = () => {
            if (!Object.keys(firebaseConfig).length) {
                console.error("Firebase config is missing.");
                return;
            }

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Auth logic
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    appUserId = user.uid;
                } else {
                    appUserId = crypto.randomUUID();
                }
                isAuthReady = true;

                if (initialAuthToken) {
                    try {
                        // Custom Token Sign In (Identifies the Admin/Owner)
                        const userCredential = await signInWithCustomToken(auth, initialAuthToken);
                        adminId = userCredential.user.uid;
                    } catch (error) {
                        console.error("Custom token sign in failed:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        if (!auth.currentUser) await signInAnonymously(auth);
                    }
                } else {
                    // Anonymous Sign In for other users
                    if (!auth.currentUser) await signInAnonymously(auth);
                }

                renderApp(); // Initial render after auth is ready
                setupRealtimeListener();
            });
        };
        
        // --- CRUD Handlers (Admin) ---
        
        // Deletion Handlers (exposed globally via window)
        window.startDelete = (id) => {
            if (!isAdmin()) return;
            const item = appState.submissions.find(s => s.id === id);
            if (!item) return;
            appState.itemToDelete = item;
            appState.isConfirmingDelete = true;
            renderApp();
        };

        window.cancelDelete = () => {
            appState.isConfirmingDelete = false;
            appState.itemToDelete = null;
            renderApp();
        };

        window.confirmDelete = async () => {
            if (!isAdmin() || !db || !appState.itemToDelete) return;
            
            const id = appState.itemToDelete.id;
            appState.isConfirmingDelete = false;
            appState.itemToDelete = null;

            try {
                await withRetry(() => deleteDoc(doc(db, submissionCollectionPath, id)));
                appState.message = `✅ 항목 (${id.substring(0, 4)}...) 이 성공적으로 삭제되었습니다.`;
            } catch (error) {
                console.error("Deletion failed:", error);
                appState.message = '❌ 삭제 중 오류가 발생했습니다: ' + error.message;
            }
            renderApp();
        };

        // Edit Handlers (exposed globally via window)
        window.startEdit = (id) => {
            if (!isAdmin()) return;
            const item = appState.submissions.find(s => s.id === id);
            if (!item) return;
            appState.editingId = id;
            appState.editForm = { courseName: item.courseName, amount: item.amount.toString() };
            renderApp();
        };

        window.cancelEdit = () => {
            appState.editingId = null;
            appState.editForm = { courseName: '', amount: '' };
            renderApp();
        };

        window.handleUpdate = async (id) => {
            if (!isAdmin() || !db) return;
            
            // Read values directly from DOM elements
            const courseInput = document.getElementById(`edit-course-${id}`);
            const amountInput = document.getElementById(`edit-amount-${id}`);

            const newCourseName = courseInput ? courseInput.value.trim() : appState.editForm.courseName;
            const newAmount = parseInt(amountInput ? amountInput.value : appState.editForm.amount);
            
            if (!newCourseName || isNaN(newAmount) || newAmount <= 0) {
                appState.message = '수정 내용을 올바르게 입력해 주세요.';
                renderApp();
                return;
            }

            try {
                await withRetry(() => 
                    updateDoc(doc(db, submissionCollectionPath, id), {
                        courseName: newCourseName,
                        amount: newAmount
                    })
                );
                appState.message = `✅ 항목 (${id.substring(0, 4)}...) 이 성공적으로 수정되었습니다.`;
                appState.editingId = null;
                appState.editForm = { courseName: '', amount: '' };
            } catch (error) {
                console.error("Update failed:", error);
                appState.message = '❌ 수정 중 오류가 발생했습니다: ' + error.message;
            }
            renderApp();
        };

        // --- Form Submission Handler ---
        window.handleSubmit = async (e) => {
            e.preventDefault();
            appState.message = '';
            appState.isSubmitting = true;
            renderApp();
            
            const form = e.target;
            const position = form.position.value;
            const name = form.name.value.trim();
            const supportArea = form.supportArea.value;
            const courseName = form.courseName.value.trim();
            const amount = parseInt(form.amount.value);

            if (!name || !courseName || isNaN(amount) || amount <= 0) {
                appState.message = '모든 필수 항목을 올바르게 입력했는지 확인해 주세요.';
                appState.isSubmitting = false;
                renderApp();
                return;
            }

            if (!db || !appUserId) {
                appState.message = '데이터베이스 연결 또는 인증 정보를 불러오는 중입니다. 잠시 후 다시 시도해 주세요.';
                appState.isSubmitting = false;
                renderApp();
                return;
            }

            try {
                const newSubmission = {
                    position,
                    name,
                    supportArea,
                    courseName,
                    amount,
                    userId: appUserId,
                    timestamp: serverTimestamp()
                };

                await withRetry(() => addDoc(collection(db, submissionCollectionPath), newSubmission));

                appState.message = '✅ 신청서가 성공적으로 제출되었습니다! (관리자만 현황 확인 가능)';
                
                // Reset form inputs
                form.name.value = '';
                form.courseName.value = '';
                form.amount.value = '';
                // Dropdowns might retain selection, no need to force reset unless necessary
                
            } catch (error) {
                console.error("Submission failed:", error);
                appState.message = '❌ 제출 중 오류가 발생했습니다: ' + error.message;
            } finally {
                appState.isSubmitting = false;
                renderApp();
            }
        };

        // --- Real-time Data Listener ---
        const setupRealtimeListener = () => {
            if (db && appUserId && isAdmin()) { 
                const q = query(collection(db, submissionCollectionPath));
                
                onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Sort logic: Position -> Name -> Timestamp
                    data.sort((a, b) => {
                        if (a.position !== b.position) return a.position.localeCompare(b.position, 'ko');
                        if (a.name !== b.name) return a.name.localeCompare(b.name, 'ko');
                        return (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0); 
                    });

                    appState.submissions = data;
                    appState.isDataLoading = false;
                    renderApp();
                }, (error) => {
                    console.error("Error fetching data:", error);
                    appState.submissions = []; 
                    
                    if (error.code === 'permission-denied') {
                        appState.message = "데이터 조회 권한이 없습니다. (Firestore 규칙 오류)";
                    } else {
                        appState.message = "데이터 로딩 중 오류가 발생했습니다.";
                    }

                    appState.isDataLoading = false;
                    renderApp();
                });
            } else if (appUserId && !isAdmin()) {
                 appState.isDataLoading = false;
                 renderApp();
            }
        };

        // --- Rendering Functions ---

        window.toggleAdminView = () => {
            appState.showAdminView = !appState.showAdminView;
            renderApp();
        };
        
        // Handle input changes for the edit modal, saving the value to appState
        window.handleEditFormChange = (field, value) => {
            appState.editForm = { ...appState.editForm, [field]: value };
        };


        const renderTableRows = () => {
            let lastPosition = null;
            let lastName = null;
            
            if (appState.submissions.length === 0) {
                const colSpan = isAdmin() ? "7" : "6";
                const message = appState.isDataLoading ? '데이터를 로딩 중입니다...' : (appState.message.includes('권한 오류') ? appState.message : '아직 제출된 신청서가 없습니다.');
                return `
                    <tr>
                        <td colspan="${colSpan}" class="px-3 py-10 text-center text-sm text-gray-500">
                            ${message}
                        </td>
                    </tr>
                `;
            }

            return appState.submissions.map((item, index) => {
                const isGroupStart = item.position !== lastPosition || item.name !== lastName;
                const isEditing = appState.editingId === item.id;
                
                lastPosition = item.position;
                lastName = item.name;
                
                const timestampText = item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'N/A';
                const rowClass = `transition duration-100 ${isEditing ? 'bg-indigo-50' : (index % 2 === 0 ? 'bg-white' : 'bg-gray-50')}`;
                
                // 4. 과정명 (Editable)
                const courseContent = isEditing ? `
                    <input
                        type="text"
                        id="edit-course-${item.id}"
                        value="${appState.editForm.courseName}"
                        onchange="handleEditFormChange('courseName', this.value)"
                        class="w-full border-gray-300 rounded-md shadow-sm text-sm p-1 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                ` : item.courseName;

                // 5. 금액 (Editable)
                const amountContent = isEditing ? `
                    <input
                        type="number"
                        id="edit-amount-${item.id}"
                        value="${appState.editForm.amount}"
                        onchange="handleEditFormChange('amount', this.value)"
                        class="w-full border-gray-300 rounded-md shadow-sm text-sm p-1 text-right focus:ring-indigo-500 focus:border-indigo-500"
                    />
                ` : item.amount.toLocaleString('ko-KR');

                // 7. 관리 (Admin Only) - Using SVG icons
                const adminControls = isAdmin() ? `
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-center">
                        ${isEditing ? `
                            <div class="flex justify-center space-x-1">
                                <button onclick="handleUpdate('${item.id}')" class="text-green-600 hover:text-green-800 p-1 rounded-full bg-green-100 transition duration-150" title="저장">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                                </button>
                                <button onclick="cancelEdit()" class="text-red-600 hover:text-red-800 p-1 rounded-full bg-red-100 transition duration-150" title="취소">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"></path><path d="M6 6l12 12"></path></svg>
                                </button>
                            </div>
                        ` : `
                            <div class="flex justify-center space-x-2">
                                <button onclick="startEdit('${item.id}')" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full transition duration-150" title="수정">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                                </button>
                                <button onclick="startDelete('${item.id}')" class="text-gray-400 hover:text-red-600 p-1 rounded-full transition duration-150" title="삭제">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </div>
                        `}
                    </td>
                ` : '';

                return `
                    <tr key="${item.id}" class="${rowClass}">
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold ${isGroupStart ? '' : 'text-gray-400'}">
                            ${isGroupStart ? item.position : '↳'}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium ${isGroupStart ? 'text-gray-900' : 'text-gray-400 italic'}">
                            ${isGroupStart ? item.name : '↳'}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700">
                            ${item.supportArea}
                        </td>
                        <td class="px-3 py-4 text-sm text-gray-700">
                            ${courseContent}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-semibold text-right text-indigo-600">
                            ${amountContent}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-xs text-gray-500">
                            ${timestampText}
                        </td>
                        ${adminControls}
                    </tr>
                `;
            }).join('');
        };


        const renderTable = () => {
            if (!isAdmin() || !appState.showAdminView) return '';

            return `
                <div class="mt-12">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-green-600"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="21" x2="10" y2="21"></line></svg>
                        실시간 제출 현황 (관리자 뷰)
                    </h2>
                    <p class="text-sm text-gray-600 mb-4">
                        신청이 제출되는 즉시 이 목록에 실시간으로 반영됩니다. **(직위 및 성명으로 그룹화됨)**
                    </p>
                    <div class="overflow-x-auto mt-8 border border-gray-200 rounded-xl shadow-lg bg-white">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">직위</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">성명</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">지원 분야</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-3/12">과정명</th>
                                    <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">금액 (원)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-2/12">제출 시각</th>
                                    ${isAdmin() ? '<th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-1/12">관리</th>' : ''}
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${renderTableRows()}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        };


        const renderApp = () => {
            const appContainer = document.getElementById('app');
            if (!appContainer) return;

            // Get current form values to persist them during re-render
            const getCurrentValue = (id, defaultValue) => document.getElementById(id)?.value || defaultValue;
            const currentPosition = getCurrentValue('position', POSITIONS[0]);
            const currentSupportArea = getCurrentValue('supportArea', SUPPORT_AREAS[0]);
            const currentName = getCurrentValue('name', '');
            const currentCourseName = getCurrentValue('courseName', '');
            const currentAmount = getCurrentValue('amount', '');


            const adminToggle = isAdmin() ? `
                <div class="mt-8 text-center">
                    <button
                        onclick="toggleAdminView()"
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white transition duration-150 ease-in-out ${appState.showAdminView ? 'bg-red-500 hover:bg-red-600 focus:ring-red-500' : 'bg-gray-700 hover:bg-gray-800 focus:ring-gray-700'}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2">
                            ${appState.showAdminView ? 
                                '<path d="M17.94 17.94A10.51 10.51 0 0 1 12 21c-7 0-10-7-10-7s.24-1.23.63-2.12M17.46 12.35l.59-.22M4.69 16.69l.4-.53M9.88 9.88c.85-.34 1.78-.5 2.72-.5a5.5 5.5 0 0 1 3.51 1.25"></path><line x1="2" y1="2" x2="22" y2="22"></line>' : 
                                '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z"></path><circle cx="12" cy="12" r="3"></circle>'
                            }
                        </svg>
                        ${appState.showAdminView ? '제출 현황 숨기기 (비공개)' : '관리자용 제출 현황 보기 (나만 보기)'}
                    </button>
                </div>
            ` : '';
            
            // Message rendering
            const messageHtml = appState.message ? `
                <div class="p-3 rounded-lg text-sm font-medium ${appState.message.startsWith('✅') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${appState.message}
                </div>
            ` : '';

            const submissionButtonContent = appState.isSubmitting ? `
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                제출 중...
            ` : `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                신청하기
            `;

            // Confirmation Modal rendering
            const modalHtml = appState.isConfirmingDelete && appState.itemToDelete ? `
                <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
                        <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            삭제 확인
                        </h3>
                        <p class="text-gray-700 mb-6">
                            정말로 이 항목을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.
                        </p>
                        <div class="bg-red-50 p-3 rounded-lg text-sm mb-6 border border-red-200">
                            <p><strong>직위/성명:</strong> ${appState.itemToDelete.position} / ${appState.itemToDelete.name}</p>
                            <p><strong>과정명:</strong> ${appState.itemToDelete.courseName}</p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button
                                onclick="cancelDelete()"
                                class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150"
                            >
                                취소
                            </button>
                            <button
                                onclick="confirmDelete()"
                                class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-150 shadow-md"
                            >
                                삭제 실행
                            </button>
                        </div>
                    </div>
                </div>
            ` : '';
            
            // Main HTML structure (using template literals for dynamic content)
            appContainer.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <header class="text-center mb-8">
                        <h1 class="text-4xl font-extrabold text-indigo-700">2025. 목포이로초등학교 연수비 지원 신청서</h1>
                    </header>

                    <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-xl border border-indigo-100">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 mr-3 text-indigo-500"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="21" x2="10" y2="21"></line></svg>
                            신청 정보 입력
                        </h2>
                        
                        ${!isAuthReady ? `
                             <div class="p-4 bg-yellow-100 text-yellow-800 rounded-lg flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-2 animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                                인증 정보를 확인 중입니다...
                            </div>
                        ` : `
                            <p class="text-xs text-gray-500 mb-4 p-2 bg-gray-50 rounded-lg">
                               🔒 현재 사용자 ID: **${appUserId}** ${isAdmin() ? '<span class="text-indigo-600 font-bold">(관리자)</span>' : ''}
                            </p>
                        `}

                        <form id="submission-form" onsubmit="handleSubmit(event)" class="space-y-6">
                            <!-- 1. 직위 및 성명 -->
                            <div class="flex flex-col sm:flex-row gap-6">
                                <div class="flex-1">
                                    <label for="position" class="block text-sm font-medium text-gray-700 mb-1">직위</label>
                                    <select
                                        id="position"
                                        name="position"
                                        class="w-full pl-3 pr-10 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out appearance-none"
                                    >
                                        ${POSITIONS.map(p => `<option value="${p}" ${p === currentPosition ? 'selected' : ''}>${p}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="flex-1">
                                    <label for="name" class="block text-sm font-medium text-gray-700 mb-1">성명 <span class="text-red-500">*</span></label>
                                    <div class="relative">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                                        <input
                                            type="text"
                                            id="name"
                                            name="name"
                                            value="${currentName}"
                                            placeholder="홍길동"
                                            required
                                            class="w-full pl-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                                        />
                                    </div>
                                </div>
                            </div>

                            <!-- 2. 지원 분야 -->
                            <div>
                                <label for="supportArea" class="block text-sm font-medium text-gray-700 mb-1">지원 분야</label>
                                <select
                                    id="supportArea"
                                    name="supportArea"
                                    class="w-full pl-3 pr-10 py-2 border border-gray-300 bg-white rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out appearance-none"
                                >
                                    ${SUPPORT_AREAS.map(a => `<option value="${a}" ${a === currentSupportArea ? 'selected' : ''}>${a}</option>`).join('')}
                                </select>
                            </div>

                            <!-- 3. 과정명 -->
                            <div>
                                <label for="courseName" class="block text-sm font-medium text-gray-700 mb-1">과정명 <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                                    <input
                                        type="text"
                                        id="courseName"
                                        name="courseName"
                                        value="${currentCourseName}"
                                        placeholder="예: 2022 개정교육과정 연수"
                                        required
                                        class="w-full pl-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                                    />
                                </div>
                            </div>

                            <!-- 4. 금액 -->
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">금액 (숫자만 입력) <span class="text-red-500">*</span></label>
                                <div class="relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                                    <input
                                        type="number"
                                        id="amount"
                                        name="amount"
                                        value="${currentAmount}"
                                        placeholder="예: 150000 (원)"
                                        required
                                        min="1"
                                        class="w-full pl-10 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none"
                                    />
                                </div>
                            </div>

                            <!-- Submission Message -->
                            <div id="message-container">
                                ${messageHtml}
                            </div>

                            <!-- Submit Button -->
                            <button
                                type="submit"
                                disabled="${appState.isSubmitting || !isAuthReady}"
                                class="w-full flex justify-center items-center py-3 px-4 border border-transparent text-sm font-semibold rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:bg-indigo-400 disabled:cursor-not-allowed"
                            >
                                ${submissionButtonContent}
                            </button>
                        </form>
                    </div>
                    
                    ${adminToggle}
                    ${renderTable()}
                </div>
                ${modalHtml}
            `;
        };

        // Start the application after the window loads
        window.onload = initFirebase;
    </script>
</body>
</html>
