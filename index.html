<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교직원 연수비 지원 신청</title>
    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 기본 글꼴 설정 */
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .container { max-width: 600px; }
        .input-style {
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem; /* rounded-lg */
            width: 100%;
            transition: all 0.2s;
        }
        .input-style:focus {
            border-color: #3b82f6; /* blue-500 */
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.25);
        }
        .required-label::after {
            content: ' *';
            color: #ef4444; /* red-500 */
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border border-gray-100">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">
                2025. 목포이로초 교원 자율연수비 지원 신청
            </h1>
            <p class="text-gray-500 mb-8 text-center">
                아래 항목을 모두 입력하신 후 제출해 주세요.
            </p>

            <form id="supportForm" class="space-y-6">
                
                <!-- 1. 직위 (Dropdown) -->
                <div>
                    <label for="position" class="block text-sm font-medium text-gray-700 required-label">직위</label>
                    <select id="position" name="position" class="input-style mt-1">
                        <option value="" disabled selected>직위를 선택하세요</option>
                        <option value="교장">교장</option>
                        <option value="교감">교감</option>
                        <option value="교사">교사</option>
                    </select>
                </div>

                <!-- 2. 성명 (Text) -->
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 required-label">성명</label>
                    <input type="text" id="name" name="name" placeholder="이름을 입력하세요" class="input-style mt-1">
                </div>

                <!-- 3. 지원 분야 (Dropdown) -->
                <div>
                    <label for="category" class="block text-sm font-medium text-gray-700 required-label">지원 분야</label>
                    <select id="category" name="category" class="input-style mt-1">
                        <option value="" disabled selected>지원 분야를 선택하세요</option>
                        <option value="직무연수">직무연수</option>
                        <option value="자격취득">자격취득</option>
                        <option value="학원수강">학원수강</option>
                        <option value="도서구입">도서구입</option>
                        <option value="대학(원) 학비">대학(원) 학비</option>
                    </select>
                </div>

                <!-- 4. 과정명 (Text) -->
                <div>
                    <label for="courseName" class="block text-sm font-medium text-gray-700 required-label">과정명/도서명</label>
                    <input type="text" id="courseName" name="courseName" placeholder="과정명 또는 도서명을 입력하세요" class="input-style mt-1">
                </div>

                <!-- 5. 금액 (Number) -->
                <div>
                    <label for="amount" class="block text-sm font-medium text-gray-700 required-label">금액 (원)</label>
                    <input type="number" id="amount" name="amount" placeholder="숫자만 입력 (예: 150000)" class="input-style mt-1" min="0">
                </div>

                <!-- 제출 버튼 -->
                <button type="submit" id="submitButton" class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-150 ease-in-out">
                    신청서 제출
                </button>
            </form>
            
            <!-- 응답 메시지 영역 -->
            <div id="messageBox" class="mt-6 p-4 rounded-lg text-center hidden" role="alert"></div>

        </div>
    </div>

    <script>
        document.getElementById('supportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const form = e.target;
            const messageBox = document.getElementById('messageBox');
            const submitButton = document.getElementById('submitButton');
            
            // 1. 유효성 검사 (모든 항목이 비어 있지 않은지 확인)
            const position = document.getElementById('position').value;
            const name = document.getElementById('name').value.trim();
            const category = document.getElementById('category').value;
            const courseName = document.getElementById('courseName').value.trim();
            const amount = document.getElementById('amount').value.trim();

            if (!position || !name || !category || !courseName || !amount) {
                showMessage('모든 필수 항목을 입력해 주세요.', 'bg-red-100 text-red-700');
                return;
            }

            // 2. 버튼 비활성화 및 로딩 표시
            submitButton.disabled = true;
            submitButton.textContent = '제출 중...';
            showMessage('', ''); // 메시지 초기화
            
            // Apps Script URL. 이 부분을 실제 배포 후 받은 URL로 변경해야 합니다.
            // const SCRIPT_URL = '<YOUR_APPS_SCRIPT_URL>'; 
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwYXIGauXNUIVGwduNtNiB0Zs7VLrvs51AFzdtpv_OrgoZdTvAVu80Zhof2NflT6dFUyg/exec'; // 임시 URL (배포 후 변경 필요)

            // 3. FormData 객체 생성
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            // 4. Fetch를 이용한 POST 요청 (Exponential Backoff 포함)
            const MAX_RETRIES = 5;
            let currentRetry = 0;

            async function submitData() {
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Apps Script는 CORS 처리를 위해 no-cors 모드가 권장됨
                        // body: JSON.stringify(data), // Apps Script는 application/x-www-form-urlencoded 또는 FormData를 더 쉽게 처리
                        body: new URLSearchParams(data)
                    });
                    
                    // no-cors 모드에서는 응답 상태를 확인할 수 없으므로, 사용자에게 성공 메시지를 표시합니다.
                    // 실제 성공 여부는 스프레드시트에서 확인해야 합니다.
                    showMessage('✅ 신청이 성공적으로 제출되었습니다. 감사합니다!', 'bg-green-100 text-green-700');
                    form.reset(); // 성공 시 폼 초기화

                } catch (error) {
                    if (currentRetry < MAX_RETRIES) {
                        const delay = Math.pow(2, currentRetry) * 1000; // 1s, 2s, 4s, 8s, ...
                        currentRetry++;
                        // console.log(`Submission failed, retrying in ${delay / 1000}s... (Attempt ${currentRetry})`);
                        setTimeout(submitData, delay);
                    } else {
                        // console.error('Form submission failed after multiple retries:', error);
                        showMessage('❌ 제출 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.', 'bg-red-100 text-red-700');
                    }
                } finally {
                    // 성공 또는 최종 실패 시 버튼 복구
                    if (currentRetry >= MAX_RETRIES || document.getElementById('messageBox').classList.contains('bg-green-100')) {
                        submitButton.disabled = false;
                        submitButton.textContent = '신청서 제출';
                    }
                }
            }
            
            submitData();

            // 메시지 박스에 내용 표시
            function showMessage(text, classes) {
                if (text) {
                    messageBox.textContent = text;
                    messageBox.className = `mt-6 p-4 rounded-lg text-center ${classes}`;
                    messageBox.classList.remove('hidden');
                } else {
                    messageBox.classList.add('hidden');
                    messageBox.className = 'mt-6 p-4 rounded-lg text-center hidden';
                }
            }
        });
    </script>
</body>
</html>
